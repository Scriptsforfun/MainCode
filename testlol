--[[
    Fluent Renewed (Custom Re-creation)
    Fixed: UIStroke Errors, Search, Auto-Settings, Profile
]]

local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

local Fluent = {
    Registry = {},
    Options = {},
    ThemeObjects = {},
    AccentColor = Color3.fromRGB(0, 120, 215),
    Window = nil,
    SaveFile = "FluentSettings.json"
}

--// Themes
local Themes = {
    Dark = {
        Main = Color3.fromRGB(25, 25, 25),
        Secondary = Color3.fromRGB(35, 35, 35),
        Stroke = Color3.fromRGB(50, 50, 50),
        Text = Color3.fromRGB(240, 240, 240),
        TextDark = Color3.fromRGB(150, 150, 150)
    },
    Light = {
        Main = Color3.fromRGB(240, 240, 240),
        Secondary = Color3.fromRGB(255, 255, 255),
        Stroke = Color3.fromRGB(200, 200, 200),
        Text = Color3.fromRGB(20, 20, 20),
        TextDark = Color3.fromRGB(100, 100, 100)
    }
}
local CurrentTheme = Themes.Dark

--// Utility Functions
local function Create(class, properties)
    local instance = Instance.new(class)
    for k, v in pairs(properties) do
        -- Fix for UIStroke error: Handle ApplyStrokeMode specifically if needed, 
        -- but usually creating it with valid properties is enough.
        instance[k] = v
    end
    return instance
end

local function MakeDraggable(handle, object)
    local Dragging, DragInput, DragStart, StartPosition
    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true
            DragStart = input.Position
            StartPosition = object.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then Dragging = false end
            end)
        end
    end)
    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then DragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == DragInput and Dragging then
            local Delta = input.Position - DragStart
            local Target = UDim2.new(StartPosition.X.Scale, StartPosition.X.Offset + Delta.X, StartPosition.Y.Scale, StartPosition.Y.Offset + Delta.Y)
            TweenService:Create(object, TweenInfo.new(0.25, Enum.EasingStyle.Quint), {Position = Target}):Play()
        end
    end)
end

function Fluent:SetTheme(color)
    Fluent.AccentColor = color
    for _, obj in pairs(Fluent.ThemeObjects) do
        if obj.IsAccent then
            if obj.Type == "BackgroundColor" then TweenService:Create(obj.Instance, TweenInfo.new(0.3), {BackgroundColor3 = color}):Play() end
            if obj.Type == "TextColor" then TweenService:Create(obj.Instance, TweenInfo.new(0.3), {TextColor3 = color}):Play() end
            if obj.Type == "ImageColor" then TweenService:Create(obj.Instance, TweenInfo.new(0.3), {ImageColor3 = color}):Play() end
        end
    end
end

--// Config System
function Fluent:SaveConfiguration()
    if not isfolder or not writefile then return end -- Executor check
    local data = {}
    for key, option in pairs(Fluent.Options) do
        data[key] = option.Value
    end
    writefile(Fluent.SaveFile, HttpService:JSONEncode(data))
end

function Fluent:LoadConfiguration()
    if not isfile or not readfile then return end
    if isfile(Fluent.SaveFile) then
        local success, decoded = pcall(function() return HttpService:JSONDecode(readfile(Fluent.SaveFile)) end)
        if success then
            for key, value in pairs(decoded) do
                if Fluent.Options[key] and Fluent.Options[key].Set then
                    Fluent.Options[key]:Set(value)
                end
            end
        end
    end
end

--// Main Window
function Fluent:CreateWindow(options)
    local Title = options.Title or "Fluent Renewed"
    local SubTitle = options.SubTitle or "Dev Build"
    local Size = options.Size or UDim2.fromOffset(580, 460)
    
    local ScreenGui = Create("ScreenGui", {
        Name = "FluentRenewed",
        Parent = RunService:IsStudio() and LocalPlayer.PlayerGui or CoreGui,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    })
    
    local Main = Create("Frame", {
        Name = "Main", Parent = ScreenGui,
        BackgroundColor3 = CurrentTheme.Main,
        Position = UDim2.new(0.5, -Size.X.Offset/2, 0.5, -Size.Y.Offset/2),
        Size = Size, ClipsDescendants = true
    })
    Create("UICorner", {Parent = Main, CornerRadius = UDim.new(0, 8)})
    -- Fixed UIStroke Error: Removed BorderMode property
    Create("UIStroke", {Parent = Main, Color = CurrentTheme.Stroke, Thickness = 1, ApplyStrokeMode = Enum.ApplyStrokeMode.Border})

    -- Sidebar
    local Sidebar = Create("Frame", {
        Parent = Main, BackgroundColor3 = CurrentTheme.Secondary,
        Size = UDim2.new(0, 200, 1, 0), BorderSizePixel = 0
    })
    Create("UIStroke", {Parent = Sidebar, Color = CurrentTheme.Stroke, Thickness = 1, ApplyStrokeMode = Enum.ApplyStrokeMode.Border})

    -- Title
    Create("TextLabel", {
        Parent = Sidebar, BackgroundTransparency = 1,
        Position = UDim2.new(0, 20, 0, 20), Size = UDim2.new(1, -40, 0, 20),
        Font = Enum.Font.GothamBold, Text = Title, TextColor3 = CurrentTheme.Text,
        TextSize = 18, TextXAlignment = Enum.TextXAlignment.Left
    })
    Create("TextLabel", {
        Parent = Sidebar, BackgroundTransparency = 1,
        Position = UDim2.new(0, 20, 0, 40), Size = UDim2.new(1, -40, 0, 15),
        Font = Enum.Font.Gotham, Text = SubTitle, TextColor3 = CurrentTheme.TextDark,
        TextSize = 12, TextXAlignment = Enum.TextXAlignment.Left
    })

    -- Search
    local SearchFrame = Create("Frame", {
        Parent = Sidebar, BackgroundColor3 = CurrentTheme.Main,
        Position = UDim2.new(0, 15, 0, 70), Size = UDim2.new(1, -30, 0, 32)
    })
    Create("UICorner", {Parent = SearchFrame, CornerRadius = UDim.new(0, 6)})
    Create("UIStroke", {Parent = SearchFrame, Color = CurrentTheme.Stroke, Thickness = 1})
    
    local SearchBox = Create("TextBox", {
        Parent = SearchFrame, BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 0), Size = UDim2.new(1, -20, 1, 0),
        Font = Enum.Font.Gotham, Text = "", PlaceholderText = "Search...",
        TextColor3 = CurrentTheme.Text, PlaceholderColor3 = CurrentTheme.TextDark,
        TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left
    })
    
    -- Tab Container
    local TabContainer = Create("ScrollingFrame", {
        Parent = Sidebar, BackgroundTransparency = 1,
        Position = UDim2.new(0, 0, 0, 115), Size = UDim2.new(1, 0, 1, -175),
        ScrollBarThickness = 2, BorderSizePixel = 0, CanvasSize = UDim2.new(0,0,0,0)
    })
    Create("UIListLayout", {Parent = TabContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
    Create("UIPadding", {Parent = TabContainer, PaddingLeft = UDim.new(0, 15), PaddingRight = UDim.new(0, 15)})

    -- Profile (Bottom Left)
    local Profile = Create("Frame", {
        Parent = Sidebar, BackgroundColor3 = CurrentTheme.Main,
        Position = UDim2.new(0, 15, 1, -55), Size = UDim2.new(1, -30, 0, 45)
    })
    Create("UICorner", {Parent = Profile, CornerRadius = UDim.new(0, 6)})
    Create("UIStroke", {Parent = Profile, Color = CurrentTheme.Stroke, Thickness = 1})
    
    local ProfileImg = Create("ImageLabel", {
        Parent = Profile, BackgroundColor3 = Color3.fromRGB(50,50,50),
        Position = UDim2.new(0, 6, 0.5, -15), Size = UDim2.new(0, 30, 0, 30),
        Image = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
    })
    Create("UICorner", {Parent = ProfileImg, CornerRadius = UDim.new(1, 0)})
    
    Create("TextLabel", {
        Parent = Profile, BackgroundTransparency = 1,
        Position = UDim2.new(0, 45, 0, 6), Size = UDim2.new(1, -50, 0, 18),
        Font = Enum.Font.GothamBold, Text = LocalPlayer.DisplayName,
        TextColor3 = CurrentTheme.Text, TextSize = 12, TextXAlignment = Enum.TextXAlignment.Left
    })
    Create("TextLabel", {
        Parent = Profile, BackgroundTransparency = 1,
        Position = UDim2.new(0, 45, 0, 24), Size = UDim2.new(1, -50, 0, 14),
        Font = Enum.Font.Gotham, Text = "@" .. LocalPlayer.Name,
        TextColor3 = CurrentTheme.TextDark, TextSize = 11, TextXAlignment = Enum.TextXAlignment.Left
    })

    -- Content Area
    local Content = Create("Frame", {
        Parent = Main, BackgroundTransparency = 1,
        Position = UDim2.new(0, 200, 0, 0), Size = UDim2.new(1, -200, 1, 0),
        ClipsDescendants = true
    })

    -- Search Dropdown
    local SearchResults = Create("ScrollingFrame", {
        Parent = Sidebar, BackgroundColor3 = CurrentTheme.Main,
        Position = UDim2.new(0, 15, 0, 105), Size = UDim2.new(1, -30, 0, 0),
        ZIndex = 5, Visible = false, BorderSizePixel = 0
    })
    Create("UICorner", {Parent = SearchResults, CornerRadius = UDim.new(0, 6)})
    Create("UIStroke", {Parent = SearchResults, Color = CurrentTheme.Stroke, Thickness = 1})
    Create("UIListLayout", {Parent = SearchResults, SortOrder = Enum.SortOrder.LayoutOrder})

    MakeDraggable(Sidebar, Main)

    -- Search Logic
    SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
        local txt = SearchBox.Text:lower()
        for _, v in pairs(SearchResults:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
        
        if txt == "" then 
            SearchResults.Visible = false 
            TabContainer.Visible = true
            return 
        end
        
        SearchResults.Visible = true
        TabContainer.Visible = false
        
        local hits = 0
        for _, item in pairs(Fluent.Registry) do
            if item.Name:lower():find(txt) then
                hits = hits + 1
                local btn = Create("TextButton", {
                    Parent = SearchResults, BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 30), Text = "  " .. item.Name,
                    TextColor3 = CurrentTheme.Text, Font = Enum.Font.Gotham,
                    TextXAlignment = Enum.TextXAlignment.Left, TextSize = 13
                })
                btn.MouseButton1Click:Connect(function()
                    item.TabFunc() -- Switch Tab
                    SearchBox.Text = ""
                    SearchResults.Visible = false
                    TabContainer.Visible = true
                    -- Flash Effect
                    local old = item.Frame.BackgroundColor3
                    TweenService:Create(item.Frame, TweenInfo.new(0.3), {BackgroundColor3 = Fluent.AccentColor}):Play()
                    task.wait(0.3)
                    TweenService:Create(item.Frame, TweenInfo.new(0.3), {BackgroundColor3 = old}):Play()
                end)
            end
        end
        SearchResults.Size = UDim2.new(1, -30, 0, math.min(hits * 30, 200))
        SearchResults.CanvasSize = UDim2.new(0, 0, 0, hits * 30)
    end)

    local Window = { Tabs = {} }
    
    function Window:SelectTab(tabId)
        -- Placeholder
    end

    function Window:AddTab(options)
        local TabName = options.Title or "Tab"
        local TabIcon = options.Icon or "" -- Icon support placeholder
        
        -- Tab Content
        local Page = Create("ScrollingFrame", {
            Parent = Content, BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0), Visible = false,
            ScrollBarThickness = 3, CanvasSize = UDim2.new(0, 0, 0, 0),
            AutomaticCanvasSize = Enum.AutomaticSize.Y
        })
        Create("UIPadding", {Parent = Page, PaddingTop = UDim.new(0, 20), PaddingLeft = UDim.new(0, 20), PaddingRight = UDim.new(0, 20), PaddingBottom = UDim.new(0, 20)})
        Create("UIListLayout", {Parent = Page, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 10)})
        
        -- Tab Button
        local Btn = Create("TextButton", {
            Parent = TabContainer, BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 34), Text = ""
        })
        Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0, 6)})
        
        local Indicator = Create("Frame", {
            Parent = Btn, BackgroundColor3 = Fluent.AccentColor,
            Position = UDim2.new(0, 0, 0.25, 0), Size = UDim2.new(0, 3, 0.5, 0),
            Visible = false
        })
        table.insert(Fluent.ThemeObjects, {Type = "BackgroundColor", Instance = Indicator, IsAccent = true})
        Create("UICorner", {Parent = Indicator, CornerRadius = UDim.new(1, 0)})

        local Label = Create("TextLabel", {
            Parent = Btn, BackgroundTransparency = 1,
            Position = UDim2.new(0, 12, 0, 0), Size = UDim2.new(1, -12, 1, 0),
            Font = Enum.Font.GothamMedium, Text = TabName,
            TextColor3 = CurrentTheme.TextDark, TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left
        })

        local function Activate()
            for _, p in pairs(Content:GetChildren()) do if p:IsA("ScrollingFrame") then p.Visible = false end end
            for _, b in pairs(TabContainer:GetChildren()) do 
                if b:IsA("TextButton") then
                    TweenService:Create(b.TextLabel, TweenInfo.new(0.2), {TextColor3 = CurrentTheme.TextDark}):Play()
                    TweenService:Create(b, TweenInfo.new(0.2), {BackgroundTransparency = 1}):Play()
                    b.Frame.Visible = false -- Hide indicator
                end
            end
            
            Page.Visible = true
            Indicator.Visible = true
            TweenService:Create(Label, TweenInfo.new(0.2), {TextColor3 = CurrentTheme.Text}):Play()
            TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(45, 45, 45), BackgroundTransparency = 0}):Play()
        end
        
        Btn.MouseButton1Click:Connect(Activate)
        if #Window.Tabs == 0 then Activate() end -- Select first tab
        table.insert(Window.Tabs, Page)

        local Tab = {}
        
        function Tab:AddToggle(key, options)
            local Title = options.Title
            local Default = options.Default or false
            local Callback = options.Callback or function() end

            local Frame = Create("Frame", {
                Parent = Page, BackgroundColor3 = CurrentTheme.Secondary,
                Size = UDim2.new(1, 0, 0, 40)
            })
            Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = Frame, Color = CurrentTheme.Stroke, Thickness = 1})

            Create("TextLabel", {
                Parent = Frame, BackgroundTransparency = 1,
                Position = UDim2.new(0, 12, 0, 0), Size = UDim2.new(1, -60, 1, 0),
                Font = Enum.Font.Gotham, Text = Title,
                TextColor3 = CurrentTheme.Text, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local Switch = Create("Frame", {
                Parent = Frame, BackgroundColor3 = Color3.fromRGB(50,50,50),
                Position = UDim2.new(1, -50, 0.5, -10), Size = UDim2.new(0, 40, 0, 20)
            })
            Create("UICorner", {Parent = Switch, CornerRadius = UDim.new(1, 0)})
            
            local Dot = Create("Frame", {
                Parent = Switch, BackgroundColor3 = Color3.fromRGB(255,255,255),
                Position = UDim2.new(0, 2, 0.5, -8), Size = UDim2.new(0, 16, 0, 16)
            })
            Create("UICorner", {Parent = Dot, CornerRadius = UDim.new(1, 0)})

            table.insert(Fluent.ThemeObjects, {Type = "BackgroundColor", Instance = Switch, IsAccent = true})
            
            local Interact = Create("TextButton", {Parent = Frame, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Text = ""})
            local State = Default
            
            local function Toggle(val)
                State = val
                local Pos = State and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
                local Col = State and Fluent.AccentColor or Color3.fromRGB(50,50,50)
                TweenService:Create(Dot, TweenInfo.new(0.2), {Position = Pos}):Play()
                TweenService:Create(Switch, TweenInfo.new(0.2), {BackgroundColor3 = Col}):Play()
                Fluent.Options[key] = {Value = State, Set = function(_, v) Toggle(v) end}
                Callback(State)
            end
            
            Interact.MouseButton1Click:Connect(function() Toggle(not State) end)
            if Default then Toggle(true) else Fluent.Options[key] = {Value = State, Set = function(_, v) Toggle(v) end} end
            
            table.insert(Fluent.Registry, {Name = Title, TabFunc = Activate, Frame = Frame})
            return Fluent.Options[key]
        end
        
        function Tab:AddSlider(key, options)
            local Title = options.Title
            local Min, Max = options.Min, options.Max
            local Default = options.Default or Min
            local Callback = options.Callback or function() end

            local Frame = Create("Frame", {
                Parent = Page, BackgroundColor3 = CurrentTheme.Secondary,
                Size = UDim2.new(1, 0, 0, 55)
            })
            Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = Frame, Color = CurrentTheme.Stroke, Thickness = 1})

            Create("TextLabel", {
                Parent = Frame, BackgroundTransparency = 1,
                Position = UDim2.new(0, 12, 0, 8), Size = UDim2.new(1, -20, 0, 15),
                Font = Enum.Font.Gotham, Text = Title,
                TextColor3 = CurrentTheme.Text, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local ValueText = Create("TextLabel", {
                Parent = Frame, BackgroundTransparency = 1,
                Position = UDim2.new(1, -60, 0, 8), Size = UDim2.new(0, 50, 0, 15),
                Font = Enum.Font.Gotham, Text = tostring(Default),
                TextColor3 = CurrentTheme.TextDark, TextSize = 13, TextXAlignment = Enum.TextXAlignment.Right
            })

            local Bar = Create("Frame", {
                Parent = Frame, BackgroundColor3 = Color3.fromRGB(50,50,50),
                Position = UDim2.new(0, 12, 0, 35), Size = UDim2.new(1, -24, 0, 6)
            })
            Create("UICorner", {Parent = Bar, CornerRadius = UDim.new(1, 0)})
            
            local Fill = Create("Frame", {
                Parent = Bar, BackgroundColor3 = Fluent.AccentColor,
                Size = UDim2.new((Default-Min)/(Max-Min), 0, 1, 0)
            })
            Create("UICorner", {Parent = Fill, CornerRadius = UDim.new(1, 0)})
            table.insert(Fluent.ThemeObjects, {Type = "BackgroundColor", Instance = Fill, IsAccent = true})
            
            local Interact = Create("TextButton", {Parent = Frame, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Text = ""})
            
            Fluent.Options[key] = {Value = Default}
            
            local function Update(input)
                local sizeX = math.clamp((input.Position.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X, 0, 1)
                local val = math.floor(Min + ((Max - Min) * sizeX))
                TweenService:Create(Fill, TweenInfo.new(0.05), {Size = UDim2.new(sizeX, 0, 1, 0)}):Play()
                ValueText.Text = tostring(val)
                Fluent.Options[key].Value = val
                Callback(val)
            end
            
            local Dragging = false
            Interact.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = true Update(i) end end)
            UserInputService.InputChanged:Connect(function(i) if Dragging and i.UserInputType == Enum.UserInputType.MouseMovement then Update(i) end end)
            UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = false end end)
            
            table.insert(Fluent.Registry, {Name = Title, TabFunc = Activate, Frame = Frame})
        end

        function Tab:AddButton(options)
            local Title = options.Title
            local Callback = options.Callback or function() end
            
            local Frame = Create("Frame", {
                Parent = Page, BackgroundColor3 = CurrentTheme.Secondary,
                Size = UDim2.new(1, 0, 0, 40)
            })
            Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = Frame, Color = CurrentTheme.Stroke, Thickness = 1})
            
            Create("TextLabel", {
                Parent = Frame, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0),
                Font = Enum.Font.Gotham, Text = Title, TextColor3 = CurrentTheme.Text,
                TextSize = 13, TextXAlignment = Enum.TextXAlignment.Center
            })
            
            local Btn = Create("TextButton", {Parent = Frame, BackgroundTransparency = 1, Size = UDim2.new(1,0,1,0), Text = ""})
            Btn.MouseButton1Click:Connect(function()
                TweenService:Create(Frame, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(50,50,50)}):Play()
                Callback()
                task.wait(0.1)
                TweenService:Create(Frame, TweenInfo.new(0.1), {BackgroundColor3 = CurrentTheme.Secondary}):Play()
            end)
            
            table.insert(Fluent.Registry, {Name = Title, TabFunc = Activate, Frame = Frame})
        end

        return Tab
    end

    --// Auto-Generate Settings Tab
    local SettingsTab = Window:AddTab({Title = "Settings", Icon = "Settings"})
    
    SettingsTab:AddButton({
        Title = "Blue Theme",
        Callback = function() Fluent:SetTheme(Color3.fromRGB(0, 120, 215)) end
    })
    SettingsTab:AddButton({
        Title = "Green Theme",
        Callback = function() Fluent:SetTheme(Color3.fromRGB(0, 255, 120)) end
    })
    SettingsTab:AddButton({
        Title = "Purple Theme",
        Callback = function() Fluent:SetTheme(Color3.fromRGB(170, 0, 255)) end
    })
    SettingsTab:AddButton({
        Title = "Red Theme",
        Callback = function() Fluent:SetTheme(Color3.fromRGB(255, 60, 60)) end
    })
    SettingsTab:AddButton({
        Title = "Save Settings",
        Callback = function() Fluent:SaveConfiguration() end
    })
    SettingsTab:AddButton({
        Title = "Load Settings",
        Callback = function() Fluent:LoadConfiguration() end
    })

    return Window
end

return Fluent
